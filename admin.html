<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Administração</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg,#1a0f1f,#2a0939,#1a0f1f);
      color: #fff; margin: 0; padding: 0;
    }
    header {
      background: #2a0939;
      padding: 15px 20px;
      border-bottom: 2px solid #ff4da6;
      text-align: center;
    }
    header h1 { margin: 0; color: #ff4da6; font-size: 1.5rem; }

    nav {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }
    nav button {
      background: #ff4da6;
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .container { padding: 20px; }
    h2 { color: #ffb6e6; margin-top: 30px; }

    table {
      width: 100%; border-collapse: collapse; margin-top: 15px;
      background: #1c0f2e; border-radius: 10px; overflow: hidden;
    }
    table th, table td { padding: 10px; text-align: center; }
    table th { background: #2a0939; color: #ff4da6; }
    table tr:nth-child(even) { background: #2a0939; }

    button {
      padding: 6px 12px; border: none; border-radius: 6px;
      cursor: pointer; font-weight: bold;
    }
    .btn-green { background: #00c853; color: #fff; }
    .btn-red { background: #d50000; color: #fff; }
    .btn-blue { background: #2962ff; color: #fff; }
    .acoes button { margin: 0 2px; }

    .calls-box {
      background: #1c0f2e;
      padding: 20px; border-radius: 12px;
      text-align: center; margin-top: 15px;
      border: 2px solid #ff4da6;
    }

    input, select {
      padding: 8px; border-radius: 6px; border: none;
      margin: 5px; font-family: inherit;
    }

    /* esconder seções por padrão */
    .secao { display: none; }
    .secao.ativo { display: block; }
  </style>
</head>
<body>
  <header>
    <h1>👑 Painel de Administração</h1>
    <nav>
      <button onclick="mostrarSecao('usuarios')">Usuários</button>
      <button onclick="mostrarSecao('calls')">Calls</button>
      <button onclick="mostrarSecao('historico')">Histórico</button>
    </nav>
  </header>

  <div class="container">

    <!-- ================= USUÁRIOS ================= -->
    <section id="usuarios" class="secao">
      <h2>📋 Controle de Usuários</h2>
      <table>
        <thead>
          <tr><th>Email</th><th>Status</th><th>Validade</th><th>Ações</th></tr>
        </thead>
        <tbody id="tabelaUsuarios"></tbody>
      </table>
    </section>

    <!-- ================= CALLS ================= -->
    <section id="calls" class="secao">
      <h2>🎯 Controle de Calls</h2>
      <div class="calls-box">
        <h3>➕ Definir Call Manual</h3>
        <input type="time" id="horaManual">
        <input type="number" id="multManual" step="0.01" placeholder="Multiplicador">
        <button class="btn-blue" onclick="definirCallManual()">Salvar Call</button>

        <h3 style="margin-top:20px;">⚡ Automatizar Calls do Dia</h3>
        <button class="btn-green" onclick="gerarCallsDoDia()">Gerar 24h</button>
        <p id="statusCalls" style="margin-top:10px; color:#ffd700;">Aguardando ação...</p>
      </div>
    </section>

    <!-- ================= HISTÓRICO ================= -->
    <section id="historico" class="secao">
      <h2>📜 Lançar Resultado Real</h2>
      <div class="calls-box">
        <input type="time" id="horaHistorico">
        <input type="number" id="multHistorico" step="0.01" placeholder="Multiplicador final">
        <button class="btn-blue" onclick="lancarResultado()">Salvar Resultado</button>
        <p id="statusHistorico" style="margin-top:10px; color:#ffd700;">Aguardando...</p>
      </div>
    </section>

  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA430IFeF_f8Z_DGgQCDg6EbXBQ6pei-1k",
      authDomain: "analises-tecnicas.firebaseapp.com",
      projectId: "analises-tecnicas",
      storageBucket: "analises-tecnicas.firebasestorage.app",
      messagingSenderId: "27903942755",
      appId: "1:27903942755:web:3a4bfd623e0b13479e1856",
      measurementId: "G-5PSFEV9208"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* =====================
       TROCAR SEÇÕES
    ====================== */
    window.mostrarSecao = (id) => {
      document.querySelectorAll(".secao").forEach(sec => sec.classList.remove("ativo"));
      document.getElementById(id).classList.add("ativo");
    };

    /* =====================
       CONTROLE DE USUÁRIOS
    ====================== */
    function carregarUsuarios(){
      onSnapshot(collection(db, "assinaturas"), (snap) => {
        let html = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const validade = d.validade?.toDate().toLocaleDateString("pt-BR") || "-";
          html += `<tr>
            <td>${d.email}</td>
            <td>${d.status}</td>
            <td>${validade}</td>
            <td class="acoes">
              <button class="btn-green" onclick="atualizarStatus('${docSnap.id}','ATIVO',30)">+30d</button>
              <button class="btn-red" onclick="atualizarStatus('${docSnap.id}','INATIVO')">Bloquear</button>
            </td>
          </tr>`;
        });
        document.getElementById("tabelaUsuarios").innerHTML = html;
      });
    }
    carregarUsuarios();

    window.atualizarStatus = async (id, status, dias) => {
      const ref = doc(db, "assinaturas", id);
      let data = { status };
      if (status === "ATIVO" && dias) {
        let nova = new Date();
        nova.setDate(nova.getDate() + dias);
        data.validade = Timestamp.fromDate(nova);
      }
      await updateDoc(ref, data);
    };

    /* =====================
       CONTROLE DE CALLS
    ====================== */
    const minutosValidos = [1,4,7,9,11,14,17,19,21,24,27,29,31,34,37,39,41,44,47,49,51,54,57,59];

    window.definirCallManual = async () => {
      const horaInput = document.getElementById("horaManual").value;
      const mult = parseFloat(document.getElementById("multManual").value);

      if (!horaInput || !mult) {
        alert("⚠ Preencha horário e multiplicador");
        return;
      }

      const [h,m] = horaInput.split(":").map(Number);
      await addDoc(collection(db,"sinais"),{
        hora:h, minuto:m, multiplicador:mult,
        criadoEm:new Date()
      });

      alert(`✅ Call ${mult}x salva para ${h}:${m}`);
    };

    function gerarMultiplicador(h,m){
      const data = new Date();
      const chave = `${data.getFullYear()}-${data.getMonth()}-${data.getDate()}-${h}-${m}`;
      let seed = 0;
      for(let i=0;i<chave.length;i++){
        seed = (seed*31 + chave.charCodeAt(i)) % 1000000;
      }
      const chance = seed % 100;
      if(chance < 70) return ((seed % 180) / 100 + 1.8).toFixed(2);
      if(chance < 95) return ((seed % 650) / 100 + 3.5).toFixed(2);
      return ((seed % 9000) / 100 + 10).toFixed(2);
    }

    window.gerarCallsDoDia = async () => {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const mes = hoje.getMonth();
      const dia = hoje.getDate();
      let total = 0;

      for(let h=0; h<24; h++){
        for(let m of minutosValidos){
          const mult = gerarMultiplicador(h,m);
          await addDoc(collection(db,"sinais"),{
            hora:h, minuto:m, multiplicador:mult,
            criadoEm:new Date(), data:`${ano}-${mes+1}-${dia}`
          });
          total++;
        }
      }
      document.getElementById("statusCalls").innerText = `✅ ${total} calls geradas para ${dia}/${mes+1}/${ano}`;
    };

    /* =====================
       LANÇAR RESULTADOS REAIS
    ====================== */
    window.lancarResultado = async () => {
      const horaInput = document.getElementById("horaHistorico").value;
      const mult = parseFloat(document.getElementById("multHistorico").value);

      if (!horaInput || !mult) {
        alert("⚠ Preencha horário e multiplicador final");
        return;
      }

      const [h,m] = horaInput.split(":").map(Number);
      await addDoc(collection(db,"historico"),{
        hora:h,
        minuto:m,
        multiplicador:mult,
        criadoEm:new Date()
      });

      document.getElementById("statusHistorico").innerText = `✅ Resultado ${mult}x salvo em ${h}:${m}`;
    };
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de AdministraÃ§Ã£o</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- TOPO -->
  <header class="topbar">
    <h1>ğŸ‘‘ Painel de <span>AdministraÃ§Ã£o</span></h1>
  </header>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de AdministraÃ§Ã£o</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg,#1a0f1f,#2a0939,#1a0f1f);
      color: #fff;
      margin: 0; padding: 0;
    }
    header {
      background: #2a0939;
      padding: 15px 20px;
      border-bottom: 2px solid #ff4da6;
      text-align: center;
    }
    header h1 { margin: 0; color: #ff4da6; font-size: 1.5rem; }
    .container { padding: 20px; }
    h2 { color: #ffb6e6; margin-top: 30px; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 15px;
      background: #1c0f2e; border-radius: 10px; overflow: hidden;
    }
    table th, table td {
      padding: 10px; text-align: center;
    }
    table th { background: #2a0939; color: #ff4da6; }
    table tr:nth-child(even) { background: #2a0939; }
    button {
      padding: 6px 12px; border: none; border-radius: 6px;
      cursor: pointer; font-weight: bold;
    }
    .btn-green { background: #00c853; color: #fff; }
    .btn-red { background: #d50000; color: #fff; }
    .btn-blue { background: #2962ff; color: #fff; }
    .acoes button { margin: 0 2px; }
    .calls-box {
      background: #1c0f2e;
      padding: 20px; border-radius: 12px;
      text-align: center; margin-top: 15px;
      border: 2px solid #ff4da6;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ‘‘ Painel de AdministraÃ§Ã£o</h1>
  </header>
  <div class="container">
    <!-- UsuÃ¡rios -->
    <section>
      <h2>ğŸ“‹ Controle de UsuÃ¡rios</h2>
      <table>
        <thead>
          <tr><th>Email</th><th>Status</th><th>Validade</th><th>AÃ§Ãµes</th></tr>
        </thead>
        <tbody id="tabelaUsuarios"></tbody>
      </table>
    </section>

    <!-- Calls -->
    <section>
      <h2>ğŸ¯ Automatizar Calls</h2>
      <div class="calls-box">
        <p>Gerar automaticamente todas as entradas (24h)</p>
        <button class="btn-blue" onclick="gerarCallsDoDia()">âš¡ Gerar Calls do Dia</button>
        <p id="statusCalls" style="margin-top:10px; color:#ffd700;">Aguardando aÃ§Ã£o...</p>
      </div>
    </section>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, onSnapshot, doc, updateDoc, setDoc, addDoc, Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Config do seu Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA430IFeF_f8Z_DGgQCDg6EbXBQ6pei-1k",
      authDomain: "analises-tecnicas.firebaseapp.com",
      projectId: "analises-tecnicas",
      storageBucket: "analises-tecnicas.firebasestorage.app",
      messagingSenderId: "27903942755",
      appId: "1:27903942755:web:3a4bfd623e0b13479e1856",
      measurementId: "G-5PSFEV9208"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Emails autorizados
    const adminEmails = ["dionegalato1212@gmail.com"];

    // AutenticaÃ§Ã£o
    onAuthStateChanged(auth, (user) => {
      if (!user || !adminEmails.includes(user.email)) {
        alert("âš ï¸ Acesso negado");
        window.location.href = "login.html";
      } else {
        carregarUsuarios();
      }
    });

    // === UsuÃ¡rios ===
    function carregarUsuarios(){
      onSnapshot(collection(db, "assinaturas"), (snap) => {
        let html = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const validade = d.validade?.toDate().toLocaleDateString("pt-BR") || "-";
          html += `<tr>
            <td>${d.email}</td>
            <td>${d.status}</td>
            <td>${validade}</td>
            <td class="acoes">
              <button class="btn-green" onclick="atualizarStatus('${docSnap.id}','ATIVO',30)">+30d</button>
              <button class="btn-red" onclick="atualizarStatus('${docSnap.id}','INATIVO')">Bloquear</button>
            </td>
          </tr>`;
        });
        document.getElementById("tabelaUsuarios").innerHTML = html;
      });
    }

    window.atualizarStatus = async (id, status, dias) => {
      const ref = doc(db, "assinaturas", id);
      let data = { status };
      if (status === "ATIVO" && dias) {
        let nova = new Date();
        nova.setDate(nova.getDate() + dias);
        data.validade = Timestamp.fromDate(nova);
      }
      await updateDoc(ref, data);
    };

    // === Calls automÃ¡ticas ===
    const minutosValidos = [1,4,7,9,11,14,17,19,21,24,27,29,31,34,37,39,41,44,47,49,51,54,57,59];

    function gerarMultiplicador(h,m){
      const data = new Date();
      const chave = `${data.getFullYear()}-${data.getMonth()}-${data.getDate()}-${h}-${m}`;
      let seed = 0;
      for(let i=0;i<chave.length;i++){
        seed = (seed*31 + chave.charCodeAt(i)) % 1000000;
      }
      const chance = seed % 100;
      if(chance < 70) return ((seed % 180) / 100 + 1.8).toFixed(2);
      if(chance < 95) return ((seed % 650) / 100 + 3.5).toFixed(2);
      return ((seed % 9000) / 100 + 10).toFixed(2);
    }

    window.gerarCallsDoDia = async () => {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const mes = hoje.getMonth();
      const dia = hoje.getDate();
      let total = 0;

      for(let h=0; h<24; h++){
        for(let m of minutosValidos){
          const mult = gerarMultiplicador(h,m);
          await addDoc(collection(db,"sinais"),{
            hora:h, minuto:m, multiplicador:mult,
            criadoEm:new Date(), data:`${ano}-${mes+1}-${dia}`
          });
          total++;
        }
      }
      document.getElementById("statusCalls").innerText = `âœ… ${total} calls geradas para ${dia}/${mes+1}/${ano}`;
    };
  </script>
</body>
</html>
  <!-- MENU -->
  <nav class="menu-admin">
    <button onclick="mostrarCard('assinaturas')" class="ativo">ğŸ“‹ Assinaturas</button>
    <button onclick="mostrarCard('velas')">ğŸ“ˆ Velas</button>
    <button onclick="mostrarCard('calls')">ğŸ¯ Calls</button>
    <button onclick="mostrarCard('gestao')">ğŸ§® GestÃ£o</button>
    <button onclick="mostrarCard('timer')">â± Timer</button>
    <button onclick="mostrarCard('live')">â–¶ï¸ Live</button>
  </nav>

  <!-- CONTEÃšDO -->
  <section class="admin-container">
    <!-- Assinaturas -->
    <div id="card-assinaturas" class="card-admin ativo">
      <h2>ğŸ“‹ Gerenciar Assinaturas</h2>
      <table class="tabela">
        <thead>
          <tr><th>Email</th><th>Status</th><th>Validade</th><th>AÃ§Ãµes</th></tr>
        </thead>
        <tbody id="assinaturasTable"></tbody>
      </table>
    </div>

    <!-- Velas -->
    <div id="card-velas" class="card-admin">
      <h2>ğŸ“ˆ Ãšltimas Velas</h2>
      <input type="number" id="velaMult" placeholder="Multiplicador">
      <button class="btn btn-blue" onclick="adicionarVela()">â• Adicionar Vela</button>
      <table class="tabela">
        <thead><tr><th>Multiplicador</th><th>HorÃ¡rio</th><th>AÃ§Ãµes</th></tr></thead>
        <tbody id="tabelaVelas"></tbody>
      </table>
    </div>

    <!-- Calls -->
    <div id="card-calls" class="card-admin">
      <h2>ğŸ¯ Controle de Calls</h2>
      <input type="number" id="tempoProx" placeholder="Tempo (s)" value="60">
      <input type="number" id="multProx" placeholder="Multiplicador" step="0.01" value="2.00">
      <button class="btn btn-blue" onclick="definirCall()">ğŸš€ LanÃ§ar Call</button>
      <button class="btn btn-green" onclick="finalizarCall('GREEN')">âœ… GREEN</button>
      <button class="btn btn-red" onclick="finalizarCall('RED')">âŒ RED</button>
      <h3>ğŸ“¢ HistÃ³rico</h3>
      <table class="tabela">
        <thead><tr><th>HorÃ¡rio</th><th>Mult</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead>
        <tbody id="tabelaCalls"></tbody>
      </table>
    </div>

    <!-- GestÃ£o -->
    <div id="card-gestao" class="card-admin">
      <h2>ğŸ§® GestÃ£o de Lucro</h2>
      <input type="number" id="lucroInput" placeholder="Valor em R$">
      <button class="btn btn-green" onclick="atualizarLucro()">ğŸ’¾ Atualizar</button>
      <p>Valor atual: R$ <span id="lucroAtual">0.00</span></p>
    </div>

    <!-- Timer -->
    <div id="card-timer" class="card-admin">
      <h2>â± Controle de Timer</h2>
      <p><strong>HorÃ¡rio:</strong> <span id="horaProx">--:--</span></p>
      <p><strong>MÃ­nimo Esperado:</strong> <span id="minProx">--</span></p>
      <p id="msgPsico">âš  Nenhum call ativo</p>
    </div>

    <!-- Live -->
    <div id="card-live" class="card-admin">
      <h2>â–¶ï¸ ConfiguraÃ§Ã£o de Live</h2>
      <input type="text" id="linkLive" placeholder="URL do YouTube">
      <button class="btn btn-blue" onclick="atualizarLive()">ğŸ’¾ Salvar</button>
      <p>Link atual: <a id="liveAtual" href="#" target="_blank">--</a></p>
    </div>
  </section>

  <!-- SCRIPT -->
  <script type="module">
    import { auth, db } from "./firebase.js";
    import { 
      collection, onSnapshot, doc, updateDoc, setDoc, addDoc, deleteDoc, Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // emails autorizados
    const adminEmails = ["dionegalato1212@gmail.com", "garotamenablog@outlook.com"];

    // autenticaÃ§Ã£o
    onAuthStateChanged(auth, (user) => {
      if (!user || !adminEmails.includes(user.email)) {
        alert("âš ï¸ Acesso negado");
        window.location.href = "login.html";
      } else {
        carregarAssinaturas();
        carregarVelas();
        carregarCalls();
        carregarLucro();
        carregarTimer();
        carregarLive();
      }
    });

    // alternÃ¢ncia de cards
    window.mostrarCard = function(nome) {
      document.querySelectorAll('.menu-admin button').forEach(b => b.classList.remove('ativo'));
      document.querySelectorAll('.card-admin').forEach(c => c.classList.remove('ativo'));
      document.querySelector(`.menu-admin button[onclick*="${nome}"]`).classList.add('ativo');
      document.getElementById("card-" + nome).classList.add('ativo');
    };

    // === Assinaturas ===
    function carregarAssinaturas() {
      onSnapshot(collection(db, "assinaturas"), (snap) => {
        let html = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const validade = d.validade?.toDate().toLocaleDateString("pt-BR") || "-";
          html += `<tr>
            <td>${d.email}</td>
            <td>${d.status}</td>
            <td>${validade}</td>
            <td>
              <button class="btn btn-green" onclick="atualizarStatus('${docSnap.id}','ATIVO',30)">+30d</button>
              <button class="btn btn-red" onclick="atualizarStatus('${docSnap.id}','INATIVO')">Inativar</button>
            </td>
          </tr>`;
        });
        document.getElementById("assinaturasTable").innerHTML = html;
      });
    }
    window.atualizarStatus = async (id, status, dias) => {
      const ref = doc(db, "assinaturas", id);
      let data = { status };
      if (status === "ATIVO" && dias) {
        let nova = new Date();
        nova.setDate(nova.getDate() + dias);
        data.validade = Timestamp.fromDate(nova);
      }
      await updateDoc(ref, data);
    };

    // === Velas ===
    function carregarVelas(){
      onSnapshot(collection(db,"velas"),(snap)=>{
        let html="";
        snap.forEach(docSnap=>{
          const d=docSnap.data();
          const hora=d.horario?.toDate().toLocaleTimeString("pt-BR")||"-";
          html+=`<tr>
            <td>${d.multiplicador}</td>
            <td>${hora}</td>
            <td><button class="acao-btn acao-remover" onclick="removerVela('${docSnap.id}')">ğŸ—‘</button></td>
          </tr>`;
        });
        document.getElementById("tabelaVelas").innerHTML=html;
      });
    }
    window.adicionarVela=async()=>{
      const mult=parseFloat(document.getElementById("velaMult").value);
      await addDoc(collection(db,"velas"),{multiplicador:mult,horario:new Date()});
    };
    window.removerVela=async(id)=>{await deleteDoc(doc(db,"velas",id));};

    // === Calls ===
    window.definirCall = async () => {
      const tempo = parseInt(document.getElementById("tempoProx").value);
      const mult = parseFloat(document.getElementById("multProx").value);
      await setDoc(doc(db,"calls","ativo"),{
        horarioLancado:new Date(),
        tempo,
        multEsperado:mult,
        status:"PENDENTE"
      });
    };
    window.finalizarCall = async (res) => {
      const mult = parseFloat(document.getElementById("multProx").value);
      const ref = doc(db,"calls","ativo");
      await updateDoc(ref, { status: res, horarioFinal: new Date() });
      await addDoc(collection(db,"callsHistorico"), { horario:new Date(), mult, status:res });
    };
    function carregarCalls(){
      onSnapshot(collection(db,"callsHistorico"),(snap)=>{
        let html="";
        snap.forEach(docSnap=>{
          const d=docSnap.data();
          const hora=d.horario?.toDate().toLocaleTimeString("pt-BR")||"-";
          html+=`<tr>
            <td>${hora}</td><td>${d.mult}</td>
            <td class="${d.status==='GREEN'?'status-green':'status-red'}">${d.status}</td>
            <td><button class="acao-btn acao-remover" onclick="removerCall('${docSnap.id}')">ğŸ—‘</button></td>
          </tr>`;
        });
        document.getElementById("tabelaCalls").innerHTML=html;
      });
    }
    window.removerCall=async(id)=>{await deleteDoc(doc(db,"callsHistorico",id));};

    // === GestÃ£o ===
    function carregarLucro(){
      onSnapshot(doc(db,"lucro","atual"),(docSnap)=>{
        if(docSnap.exists()){
          document.getElementById("lucroAtual").innerText=docSnap.data().valor.toFixed(2);
        }
      });
    }
    window.atualizarLucro=async()=>{
      const val=parseFloat(document.getElementById("lucroInput").value);
      await setDoc(doc(db,"lucro","atual"),{valor:val});
    };

    // === Timer ===
    function carregarTimer(){
      onSnapshot(doc(db,"calls","ativo"),(snap)=>{
        if(snap.exists()){
          const call=snap.data();
          document.getElementById("horaProx").innerText = call.horarioLancado?.toDate?.().toLocaleTimeString("pt-BR") || "--:--";
          document.getElementById("minProx").innerText = call.multEsperado+"x";
          document.getElementById("msgPsico").innerText = call.status;
        }
      });
    }

    // === Live ===
    function carregarLive(){
      onSnapshot(doc(db,"config","live"),(snap)=>{
        if(snap.exists()){
          const url=snap.data().url;
          document.getElementById("liveAtual").innerText=url;
          document.getElementById("liveAtual").href=url;
        }
      });
    }
    window.atualizarLive=async()=>{
      const url=document.getElementById("linkLive").value;
      await setDoc(doc(db,"config","live"),{url});
    };
  </script>
</body>
</html>
